{% extends "layouts/base.html" %}

{% block title %}{{ thread.title }}{% endblock title %}

{% block main %}
<link rel="stylesheet" href="{{ url_for('static', filename='forum/css/discussion.css') }}">
<!-- Mobile Sidebar Menu -->
<div class="mobile-sidebar" id="mobileSidebar">
    <div class="mobile-sidebar-header">
        <h2>Menu</h2>
        <button class="menu active" id="closeSidebar">
            <span class="menu__inner"></span>
        </button>
    </div>

    <div class="mobile-sidebar-content">
        <!-- Home Link -->
        <a href="/" class="sidebar-menu-item">
            <i class="fas fa-home"></i>
            <span>Home</span>
        </a>

        <!-- Admin Link (if authenticated) -->
        {% if current_user.is_authenticated and current_user.role == 1 %}
        <a href="/admin/views" class="sidebar-menu-item">
            <i class="fas fa-user-shield"></i>
            <span>Admin Panel</span>
        </a>
        {% endif %}

        <!-- User Profile -->
        {% if current_user.is_authenticated %}
        <a href="/forum/settings/" class="sidebar-menu-item">
            <i class="fas fa-user"></i>
            <span>{{ current_user.name }}</span>
        </a>
        {% else %}
        <a href="{{ url_for('web.login') }}" class="sidebar-menu-item">
            <i class="fas fa-sign-in-alt"></i>
            <span>Login</span>
        </a>
        {% endif %}

        <!-- Time Display -->
        <div class="sidebar-menu-item sidebar-info">
            <i class="fas fa-clock"></i>
            <span id="currentTime"></span>
        </div>

        <!-- Divider -->
        <div class="sidebar-divider"></div>

        <!-- Thread Actions (Edit/Delete) -->
        {% if current_user.is_authenticated and thread.is_owner(current_user) %}
        <div class="sidebar-section-title">Thread Actions</div>

        <a href="{{ url_for('threads.edit', category_slug=thread.category.slug, thread_slug=thread.slug) }}"
            class="sidebar-menu-item sidebar-edit">
            <i class="fas fa-edit"></i>
            <span>Edit Thread</span>
        </a>

        <button class="sidebar-menu-item sidebar-delete" id="deleteThreadBtn">
            <i class="fas fa-trash"></i>
            <span>Delete Thread</span>
        </button>
        {% endif %}

        <!-- Book Info -->
        <div class="sidebar-divider"></div>
        <div class="sidebar-section-title">Discussion Info</div>

        <div class="sidebar-menu-item sidebar-info">
            <i class="fas fa-tag"></i>
            <span>{{ thread.category.name }}</span>
        </div>

        <div class="sidebar-menu-item sidebar-info">
            <i class="fas fa-eye"></i>
            <span>{{ thread.views_count }} views</span>
        </div>

        <div class="sidebar-menu-item sidebar-info">
            <i class="fas fa-comments"></i>
            <span>{{ thread.comments|length }} comments</span>
        </div>
    </div>
</div>

<!-- Sidebar Overlay -->
<div class="sidebar-overlay" id="sidebarOverlay"></div>

<div class="discussion-container" style="position: relative;">
    <!-- left Side: Book Reader (40%) -->
    <div class="book-reader-panel">
        <div class="book-reader-header">
            <h2>
                <i class="fas fa-book-open"></i>
                {% if book %}{{ book.title }}{% else %}Book Reader{% endif %}
            </h2>
        </div>
        <div class="book-reader-content">
            {% if book and book_format %}
            <iframe src="{{ url_for('web.read_book', book_id=book.id, book_format=book_format) }}"
                class="book-reader-iframe" title="{{ book.title }}">
            </iframe>
            {% else %}
            <div class="no-book-message">
                <i class="fas fa-book"></i>
                <h3>No Book Linked</h3>
                <p>This discussion doesn't have a linked book to read.</p>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- right Side: Discussion (60%) -->
    <div class="discussion-panel">
        <!-- Main Discussion Feed -->
        <div class="discussion-feed">
            <!-- Thread Header -->
            <div class="thread-header-card">
                <a href="/" class="back-home" role="button" title="Back to Home">
                    <i class="fas fa-home"></i>
                </a>
                <div class="discussion-book-cover">
                    <img src="{{ url_for('web.get_cover', book_id=thread.book_id, resolution='og') }}" alt="Book Cover">
                </div>
                <div class="discussion-header">
                    <button class="menu" id="menuBtn">
                        <span class="menu__inner"></span>
                    </button>
                    <h1 class="thread-title">{{ thread.title }}</h1>

                    <div class="thread-meta">
                        <span class="thread-category">
                            <i class="fas fa-tag"></i> {{ thread.category.name }}
                        </span>
                        <span class="thread-author">
                            <i class="fas fa-user"></i>
                            Posted by <strong>{{ thread.owner.name }}</strong>
                        </span>
                        <span class="thread-author">
                            <i class="fas fa-eye"></i> {{ thread.views_count }} views
                        </span>
                    </div>

                    <div class="thread-content">
                        {{ thread.content | markdown }}
                    </div>

                    {% if current_user.is_authenticated and thread.is_owner(current_user) %}
                    <div class="thread-actions">
                        <a href="{{ url_for('threads.edit', category_slug=thread.category.slug, thread_slug=thread.slug) }}"
                            class="btn-edit">
                            <i class="fas fa-edit"></i> Edit
                        </a>
                        <form action="{{ url_for('threads.show', 
                                        category_slug=thread.category.slug,
                                        thread_slug=thread.slug) }}?_method=DELETE" method="POST" class="form-delete"
                            onsubmit="return confirm('Are you sure you want to delete this discussion?');">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}" />
                            <button type="submit" class="btn-delete">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </form>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Comments Section -->
            <div class="comments-section">
                <!-- <h2 class="comments-header" style="display: none;">
                    <i class="fas fa-comments"></i>
                    Chat ({{ thread.comments|length }} messages)
                </h2> -->
                <comments :id="{{ thread.id }}"></comments>
            </div>
        </div>
        <!-- Right Sidebar -->
        <div class="discussion-sidebar">
            <!-- Top Contributors -->
            <div class="sidebar-widget">
                <h3 class="sidebar-widget-title">
                    <i class="fas fa-trophy"></i>
                    Top Contributors
                </h3>

                {% if top_contributors %}
                {% for contributor in top_contributors %}
                <div class="contributor-item">
                    <div class="contributor-avatar">
                        {% if contributor.user.forum_avatar %}
                        <img src="{{ url_for('static', filename='forum/images/avatars/' + contributor.user.forum_avatar) }}"
                            alt="{{ contributor.user.name }}">
                        {% else %}
                        {{ contributor.user.name[0]|upper }}
                        {% endif %}
                    </div>
                    <div class="contributor-info">
                        <div class="contributor-name">{{ contributor.user.name }}</div>
                        <div class="contributor-count">
                            <i class="fas fa-comment"></i> {{ contributor.comment_count }} comment{{ 's' if
                            contributor.comment_count != 1 else '' }}
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p style="color: #6b7280; font-size: 0.9rem;">No contributors yet. Be the first to comment!</p>
                {% endif %}
            </div>

            <!-- Recent Discussions -->
            <div class="sidebar-widget">
                <h3 class="sidebar-widget-title">
                    <i class="fas fa-fire"></i>
                    Recent Discussions
                </h3>

                {% if recent_discussions %}
                {% for discussion in recent_discussions %}
                <a href="{{ url_for('threads.show', category_slug=discussion.category.slug, thread_slug=discussion.slug) }}"
                    class="discussion-item" style="display: block; text-decoration: none; color: inherit;">
                    <div class="discussion-title">{{ discussion.title }}</div>
                    <div class="discussion-stats">
                        <span class="discussion-stat">
                            <i class="fas fa-comment"></i> {{ discussion.comments_count }}
                        </span>
                        <span class="discussion-stat">
                            <i class="fas fa-eye"></i> {{ discussion.views_count }}
                        </span>
                    </div>
                </a>
                {% endfor %}
                {% else %}
                <p style="color: #6b7280; font-size: 0.9rem;">No recent discussions.</p>
                {% endif %}
            </div>

            <!-- Quick Stats -->
            <div class="sidebar-widget">
                <h3 class="sidebar-widget-title">
                    <i class="fas fa-chart-bar"></i>
                    Discussion Stats
                </h3>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 16px;">
                    <div
                        style="text-align: center; padding: 16px; background: linear-gradient(135deg, #6366f1, #818cf8); border-radius: 12px; color: white;">
                        <div style="font-size: 2rem; font-weight: 700;">{{ thread.comments|length }}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 4px;">Comments</div>
                    </div>
                    <div
                        style="text-align: center; padding: 16px; background: linear-gradient(135deg, #10b981, #059669); border-radius: 12px; color: white;">
                        <div style="font-size: 2rem; font-weight: 700;">{{ thread.views_count }}</div>
                        <div style="font-size: 0.8rem; opacity: 0.9; margin-top: 4px;">Views</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>



<!-- <style>
    /* Additional inline styles for Vue component integration */
    .comment-form {
        margin-bottom: 24px;
        padding: 20px;
        background: #f9fafb;
        border-radius: 12px;
        border: 1px solid #e5e7eb;
    }

    .comment-form textarea {
        width: 100%;
        min-height: 120px;
        padding: 16px;
        border: 2px solid #e5e7eb;
        border-radius: 10px;
        font-size: 1rem;
        font-family: inherit;
        resize: vertical;
        transition: all 0.3s ease;
    }

    .comment-form textarea:focus {
        outline: none;
        border-color: #6366f1;
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }

    .comment-form button {
        margin-top: 12px;
        padding: 12px 28px;
        background: linear-gradient(135deg, #6366f1, #818cf8);
        color: white;
        border: none;
        border-radius: 8px;
        font-weight: 600;
        font-size: 1rem;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .comment-form button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3);
    }

    .comment-form button:active {
        transform: translateY(0);
    }
</style> -->
{% endblock main %}